---
name: Check Dependent Libraries on Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to process (e.g., platform/alz/1.2.3)'
        required: true

permissions:
  contents: write

jobs:
  release:
    name: Check Release
    runs-on: ubuntu-latest
    environment: libupdate
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: install tools
        run: make tools
        working-directory: ${{ github.workspace }}/${{ github.repository }}

      - uses: actions/create-github-app-token@c1a285145b9d317df6ced56c09f525b5c2b6f755 # v1.11.1
        id: generate-token
        with:
          app-id: ${{ secrets.TOKEN_APP_ID }}
          private-key: ${{ secrets.TOKEN_APP_PRIVATE_KEY }}

      - name: Update ALZ Dependencies
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          $tag = "${{ inputs.release_tag || github.ref_name }}"
          $alzPath = "platform/alz"
          $alzPrefix = "$alzPath/"

          # Validate tag format (must be platform/alz/X.Y.Z or similar semver pattern)
          if ($tag -notmatch "^$([regex]::Escape($alzPrefix))\d+\.\d+\.\d+(-[\w\.]+)?$") {
            Write-Host "Tag '$tag' does not match expected format 'platform/alz/X.Y.Z'. Skipping."
            exit 0
          }

          $currentALZVersion = $tag.Replace($alzPrefix, "")

          # Find all libraries that depend on ALZ
          $libraryMetadataFiles = Get-ChildItem -Path "platform" -Filter "alz_library_metadata.json" -Recurse
          $updatedFiles = @()

          foreach ($metadataFile in $libraryMetadataFiles) {
            $metadata = Get-Content -Path $metadataFile.FullName | ConvertFrom-Json

            # Skip if no dependencies
            if (-not $metadata.dependencies) {
              continue
            }

            # Find ALZ dependency
            $alzDependency = $metadata.dependencies | Where-Object { $_.path -eq $alzPath }
            if (-not $alzDependency) {
              continue
            }

            $currentDependencyVersion = $alzDependency.ref
            if ($currentDependencyVersion -eq $currentALZVersion) {
              Write-Host "$($metadata.name): ALZ dependency version already matches $currentALZVersion"
              continue
            }

            Write-Host "$($metadata.name): Updating ALZ dependency from $currentDependencyVersion to $currentALZVersion"

            $content = Get-Content -Path $metadataFile.FullName -Raw
            $content = $content -replace [regex]::Escape("`"ref`": `"$currentDependencyVersion`""), "`"ref`": `"$currentALZVersion`""
            Set-Content -Path $metadataFile.FullName -Value $content -NoNewline

            $updatedFiles += $metadataFile.FullName

            make docs LIB="$($metadata.name)"
          }

          if ($updatedFiles.Count -eq 0) {
            Write-Host "No libraries require ALZ dependency updates."
            exit 0
          }

          # Create a branch, update the files and create a PR
          $branchName = "update-alz-dependency-$currentALZVersion"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b $branchName
          
          git add .
          git commit -m "Update ALZ dependency to $currentALZVersion"
          git push origin $branchName

          gh pr create `
            --title "Update ALZ dependency to $currentALZVersion" `
            --body "This PR updates library metadata files to reference ALZ version $currentALZVersion.`n`nUpdated files:`n$($updatedFiles -join "`n")`n`nThis was automatically generated by the release workflow." `
            --base main `
            --head $branchName
        shell: pwsh
